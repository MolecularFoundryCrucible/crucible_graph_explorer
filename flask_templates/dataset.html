{% macro render_dict_recursive(d) %}
    <ul>
    {% for key, value in d.items() %}
        <li>
            <b>{{ key }}</b>: 
            {% if value is mapping %}
                {{ render_dict_recursive(value) }}
            {% else %}
                {{ value if value is not none else "N/A" }}
            {% endif %}
        </li>
    {% endfor %}
    </ul>
{% endmacro %}

{% extends "base.html" %}
{% block title %}{{ds['dataset_name']}}{% endblock %}
{% block head %}
    {{ super() }}
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/themes/default/style.min.css" />
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/{{project_id}}/"><b>Project</b> {{project_id}}</a></li>
    <li class="breadcrumb-item active" aria-current="page"><b>Dataset</b> {{ds['dataset_name']}}</li>
{% endblock %}


{% block content %}

    <h1><em>Dataset</em> {{ds['dataset_name']}}</h1>

    <div>
    <img src="{{ qrcode(ds['unique_id'], box_size=5, border=5) }}">
    </div>

    <span class="mfid">{{ds['unique_id']}}</span>

    <ul>
    {% for k,v in ds.items()%} 
    {% if k != "scientific_metadata" %}
    <li>
        <b>{{k}}</b>: {{v}}
    </li>
    {% endif %}
    {% endfor %}
    </ul>

    <h2>Thumbnails</h2>
    <div class="card-columns">
    {% for thumb in thumbnails %}
    <div class="card" style="width: 25em;">
        <div class="card-header">{{thumb['thumbnail_name']}}</div>
        <img class="card-img-top" src="data:image/png;base64, {{thumb['thumbnail_b64str']}}" alt="{{thumb['thumbnail_name']}}"/>
    </div>
    {% endfor %}
    
    <h2>Samples</h2>
    <div class="card-columns">
    {% for sample in samples %}
        <div class="card" style="width: 25em;">
              <h3 class="card-header">{{sample['sample_name']}}</h5>
              <div class="card-body">  
                <a href="/{{project_id}}/sample-graph/{{sample['unique_id']}}" class="card-subtitle mb-2 text-muted mfid">
                    {{sample['unique_id'][:13]}}</a>
            <p class="card-text">{{sample['description']}} | {{sample['date_created']}}</p>
            </div>
        </div>
    {% endfor %}
    </div>

    
    <h2>Parent Datasets</h2>
    <ul>
        {% for ds in parent_datasets %}
        <li>
            <a href="/{{project_id}}/dataset/{{ds['unique_id']}}"  class="mfid">{{ds['unique_id'][:13]}}</a>
            {{ds['dataset_name']}}
        </li>
        {% endfor %}        
    </ul>
    <h2>Child Datasets</h2>
    <ul>
        {% for ds in child_datasets %}
        <li>
            <a href="/{{project_id}}/dataset/{{ds['unique_id']}}"  class="mfid">{{ds['unique_id'][:13]}}</a>
            {{ds['dataset_name']}}
        </li>
        {% endfor %}        
    </ul>
    
    <h2>Scientific Metadata</h2>

    <input id="tree_search" type="text">
    <div id="jstree">
        {{ render_dict_recursive(ds['scientific_metadata']) }}
    </div>

  <!-- 5 include the minified jstree source -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.2.1/jstree.min.js"></script>
  <script>
  $(function () {
    // 6 create an instance when the DOM is ready
    $('#jstree').jstree({
    'search': {
            'case_insensitive': true,
            'show_only_matches' : false
        },
        'plugins': ['search', 'wholerow']
    }).on('search.jstree', function (nodes, str, res) {
        if (str.nodes.length===0) {
            $('#jstree').jstree(true).hide_all();
        }
    });

    // 7 bind to events triggered on the tree
    $('#jstree').on("changed.jstree", function (e, data) {
      console.log(data.selected);
    });
    // 8 interact with the tree - either way is OK
    $('button').on('click', function () {
      $('#jstree').jstree(true).select_node('child_node_1');
      $('#jstree').jstree('select_node', 'child_node_1');
      $.jstree.reference('#jstree').select_node('child_node_1');
    });

    $('#tree_search').keyup(function(){
        $('#jstree').jstree(true).show_all();
        $('#jstree').jstree('search', $(this).val());
    });
    $("#jstree").jstree("open_all");
  });
  </script>

  <h2>Files</h2>
    <ul>
    {% for file in files %}
        <li>
            <a href="/file/{{file['file_id']}}" class="mfid">{{file['file_id']}}</a> : {{file['filename']}} ({{file['size']}} bytes)
        </li>
    {% endfor %}
    </ul>

    <h2>Download Links</h2>
    <ul>
    {% for fname,link in download_links.items() %}
        <li>
            <a href="{{link}}" target="_blank">{{fname}}</a>
        </li>
    {% endfor %}

{% endblock %}