{% macro render_dict_recursive(d) %}
<div class="metadata-tree">
{% for key, value in d.items() %}
    {% if value is mapping %}
    <details class="tree-node" open>
        <summary class="tree-summary"><b>{{ key }}</b></summary>
        <div class="tree-children">{{ render_dict_recursive(value) }}</div>
    </details>
    {% else %}
    <div class="tree-leaf"><b>{{ key }}</b>: {{ value if value is not none else "N/A" }}</div>
    {% endif %}
{% endfor %}
</div>
{% endmacro %}

{% extends "base.html" %}
{% block title %}{{ds['dataset_name']}}{% endblock %}
{% block head %}
    {{ super() }}
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
        <style>
            .metadata-tree { font-family: monospace; font-size: 0.9rem; }
            .tree-node { margin: 1px 0; }
            .tree-summary {
                cursor: pointer;
                padding: 2px 4px;
                border-radius: 3px;
                list-style: none;
                user-select: none;
            }
            .tree-summary::-webkit-details-marker { display: none; }
            .tree-summary::before {
                content: 'â–¶';
                display: inline-block;
                width: 1em;
                font-size: 0.75em;
                transition: transform 0.15s;
                color: #6c757d;
            }
            details[open] > .tree-summary::before { transform: rotate(90deg); }
            .tree-summary:hover { background-color: #f0f4f8; }
            .tree-children { padding-left: 1.5em; border-left: 1px solid #dee2e6; margin-left: 0.5em; }
            .tree-leaf { padding: 2px 4px; margin: 1px 0; }
            .tree-leaf:hover { background-color: #f0f4f8; border-radius: 3px; }
            mark { background-color: #f8d7da; color: #842029; border-radius: 2px; padding: 0 2px; font-weight: bold; }
            .markdown-content {
                line-height: 1.6;
                margin: 20px 0;
            }
            .markdown-content h1, .markdown-content h2, .markdown-content h3,
            .markdown-content h4, .markdown-content h5, .markdown-content h6 {
                margin-top: 24px;
                margin-bottom: 16px;
                font-weight: 600;
            }
            .markdown-content h1 { font-size: 2em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
            .markdown-content h2 { font-size: 1.5em; border-bottom: 1px solid #eaecef; padding-bottom: 0.3em; }
            .markdown-content h3 { font-size: 1.25em; }
            .markdown-content h4 { font-size: 1em; }
            .markdown-content p { margin-bottom: 16px; }
            .markdown-content ul, .markdown-content ol {
                margin-bottom: 16px;
                padding-left: 2em;
            }
            .markdown-content li { margin-bottom: 4px; }
            .markdown-content code {
                background-color: rgba(175, 184, 193, 0.2);
                padding: 0.2em 0.4em;
                border-radius: 6px;
                font-size: 85%;
            }
            .markdown-content pre {
                background-color: #f6f8fa;
                border-radius: 6px;
                padding: 16px;
                overflow: auto;
                margin-bottom: 16px;
            }
            .markdown-content pre code {
                background-color: transparent;
                padding: 0;
            }
            .markdown-content blockquote {
                border-left: 4px solid #dfe2e5;
                padding-left: 16px;
                margin-left: 0;
                color: #6a737d;
            }
            .markdown-content table {
                border-collapse: collapse;
                width: 100%;
                margin-bottom: 16px;
            }
            .markdown-content table th, .markdown-content table td {
                border: 1px solid #dfe2e5;
                padding: 6px 13px;
            }
            .markdown-content table th {
                background-color: #f6f8fa;
                font-weight: 600;
            }
            .markdown-content img {
                max-width: 100%;
                height: auto;
            }
        </style>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/{{project_id}}/"><b>Project</b> {{project_id}}</a></li>
    <li class="breadcrumb-item active" aria-current="page"><b>Dataset</b> {{ds['dataset_name']}}</li>
{% endblock %}


{% block content %}

    <div class="d-flex align-items-start justify-content-between">
        <h1 style="min-width:0; overflow-wrap:break-word;"><em>Dataset</em> {{ds['dataset_name']}}</h1>
        <img src="{{ qrcode(ds['unique_id'], box_size=5, border=5) }}">
    </div>

    <span class="mfid">{{ds['unique_id']}}</span>

    <ul>
    {% for k,v in ds.items()%}
    {% if k != "scientific_metadata" %}
    <li>
        <b>{{k}}</b>: {{v}}
    </li>
    {% endif %}
    {% endfor %}
    </ul>

    {% if markdown_html %}
    <h2>Note Content</h2>
    <div class="markdown-content card">
        <div class="card-body">
            {{ markdown_html|safe }}
        </div>
    </div>
    {% endif %}

    <h2>Thumbnails</h2>
    <div class="card-columns">
    {% for thumb in thumbnails %}
    <div class="card" style="width: 25em;">
        <div class="card-header">{{thumb['thumbnail_name']}}</div>
        <img class="card-img-top" src="data:image/png;base64, {{thumb['thumbnail_b64str']}}" alt="{{thumb['thumbnail_name']}}"/>
    </div>
    {% endfor %}
    
    <h2>Samples</h2>
    <div class="card-columns">
    {% for sample in samples %}
        <div class="card" style="width: 25em;">
              <h3 class="card-header">{{sample['sample_name']}}</h5>
              <div class="card-body">  
                <a href="/{{project_id}}/sample-graph/{{sample['unique_id']}}" class="card-subtitle mb-2 text-muted mfid">
                    {{sample['unique_id'][:13]}}</a>
            <p class="card-text">{{sample['description']}} | {{sample['date_created']}}</p>
            </div>
        </div>
    {% endfor %}
    </div>

    
    <h2>Parent Datasets</h2>
    <ul>
        {% for ds in parent_datasets %}
        <li>
            <a href="/{{project_id}}/dataset/{{ds['unique_id']}}"  class="mfid">{{ds['unique_id'][:13]}}</a>
            {{ds['dataset_name']}}
        </li>
        {% endfor %}        
    </ul>
    <h2>Child Datasets</h2>
    <ul>
        {% for ds in child_datasets %}
        <li>
            <a href="/{{project_id}}/dataset/{{ds['unique_id']}}"  class="mfid">{{ds['unique_id'][:13]}}</a>
            {{ds['dataset_name']}}
        </li>
        {% endfor %}        
    </ul>
    
    <h2>Scientific Metadata</h2>

    <input id="tree_search" type="text" class="form-control form-control-sm mb-2" placeholder="Search metadata...">
    <div id="metadata-tree-root">
        {{ render_dict_recursive(ds['scientific_metadata']) }}
    </div>

  <script>
  function highlightTextNodes(el, query) {
    const walker = document.createTreeWalker(el, NodeFilter.SHOW_TEXT);
    const textNodes = [];
    let node;
    while (node = walker.nextNode()) textNodes.push(node);
    textNodes.forEach(textNode => {
      const lower = textNode.textContent.toLowerCase();
      const idx = lower.indexOf(query);
      if (idx === -1) return;
      const before = textNode.textContent.slice(0, idx);
      const match  = textNode.textContent.slice(idx, idx + query.length);
      const after  = textNode.textContent.slice(idx + query.length);
      const frag = document.createDocumentFragment();
      if (before) frag.appendChild(document.createTextNode(before));
      const mark = document.createElement('mark');
      mark.textContent = match;
      frag.appendChild(mark);
      if (after) frag.appendChild(document.createTextNode(after));
      textNode.parentNode.replaceChild(frag, textNode);
    });
  }

  document.getElementById('tree_search').addEventListener('input', function () {
    const query = this.value.trim().toLowerCase();
    const root = document.getElementById('metadata-tree-root');

    // Restore original HTML for all labelled elements
    root.querySelectorAll('.tree-leaf, .tree-summary').forEach(el => {
      if (el.dataset.originalHtml !== undefined)
        el.innerHTML = el.dataset.originalHtml;
    });
    root.querySelectorAll('details').forEach(d => { d.open = true; });

    if (!query) return;

    root.querySelectorAll('.tree-leaf, .tree-summary').forEach(el => {
      if (el.dataset.originalHtml === undefined)
        el.dataset.originalHtml = el.innerHTML;
      if (el.textContent.toLowerCase().includes(query))
        highlightTextNodes(el, query);
    });
  });
  </script>

  <h2>Files</h2>
    <ul>
    {% for file in files %}
        <li>
            <a href="/file/{{file['file_id']}}" class="mfid">{{file['file_id']}}</a> : {{file['filename']}} ({{file['size']}} bytes)
        </li>
    {% endfor %}
    </ul>

    <h2>Download Links</h2>
    <ul>
    {% for fname,link in download_links.items() %}
        <li>
            <a href="{{link}}" target="_blank">{{fname}}</a>
        </li>
    {% endfor %}

{% endblock %}