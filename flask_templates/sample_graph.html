{% set s = self_info %}

{% extends "base.html" %}
{% block title %}{{s['sample_name']}}{% endblock %}

{% block head %}
    {{ super() }}
    {{ vite_tags() }}
    <style type="text/css">
        .important { color: #336699; }
        #cy {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 2rem;
        }
    </style>
{% endblock %}

{% block breadcrumb %}
        <li class="breadcrumb-item"><a href="/{{pc['project_id']}}/"><b>Project</b> {{pc['project_id']}}</a></li>
        <li class="breadcrumb-item active" aria-current="page"><b>Sample</b> {{s['sample_name']}}</li>
{% endblock %}

{% block content %}

<div class="d-flex align-items-start justify-content-between">
    <h1><em>Sample</em> {{s['sample_name']}} <span class="mfid">{{s['unique_id'][:13]}}</span></h1>
    <img src="{{ qrcode(s['unique_id'], box_size=5, border=5) }}">
</div>

<div class="container card">

    <ul>
    <li><b>Description:</b> {{s['description']}}</li>
    <li><b>Datasets:</b>
        <ul>
            {% for ds in s['datasets'] %}
            <li>
                <a href="/{{pc['project_id']}}/dataset/{{ds['unique_id']}}" class="mfid">{{ds['unique_id'][:13]}}</a>
                <b>{{ds['dataset_name']}}</b>
                <!-- {{datasets_by_id[ds['unique_id']]['scientific_metadata']|string|truncate(1000)}} -->
            </li>
            {% endfor %}
        </ul>
    </ul>
</div>

<h2>Sample Graph</h2>
<div class="d-flex gap-2 mb-2">
  <button id="toggleLayoutBtn" class="btn btn-sm btn-secondary">
    Switch to Vertical Layout
  </button>
  <a href="/{{pc['project_id']}}/entity-graph/sample/{{s['unique_id']}}" class="btn btn-sm btn-outline-success">
    View with Datasets
  </a>
</div>
<div id="cy" data-project-id="{{pc['project_id']}}"></div>

<script type="module">
  let cyInstance = null;
  let currentLayout = 'LR';

  // Wait for the page to load and for the initSampleGraph function to be available
  async function initGraph() {
    // Fetch the graph data from the API
    const response = await fetch('/{{pc["project_id"]}}/api/sample-graph-data/{{s["unique_id"]}}');
    const graphData = await response.json();

    // Initialize the graph when window.initSampleGraph is available
    if (window.initSampleGraph) {
      cyInstance = window.initSampleGraph('cy', graphData);
    } else {
      // If not immediately available, wait for it
      setTimeout(initGraph, 100);
    }
  }

  // Toggle layout button handler
  document.getElementById('toggleLayoutBtn').addEventListener('click', function() {
    if (cyInstance && cyInstance.toggleLayout) {
      const newLayout = cyInstance.toggleLayout();
      currentLayout = newLayout;
      this.textContent = newLayout === 'LR' ? 'Switch to Vertical Layout' : 'Switch to Horizontal Layout';
    }
  });

  // Start initialization when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGraph);
  } else {
    initGraph();
  }
</script>



<h2>Ancestors</h2>
{% for s in ancestors_info %}
    {% set name = s['sample_name'] %}
    <div class="container p-4 border rounded-3 mt-2">
    <h3>{{name}}
        <a href="/{{pc['project_id']}}/sample-graph/{{s['unique_id']}}" class="mfid">
            {{s['unique_id'][:13]}}</a>
    </h3>
    <ul>
        <li><b>Path:</b> {{" <- ".join(ancestors_path[name])}}</li>
        <li><b>Description:</b> {{s['description']}}</li>
        <li><b>Datasets:</b>
            <ul>
            {% for ds in s['datasets'] %}
                <li>
                    <a href="/{{pc['project_id']}}/dataset/{{ds['unique_id']}}" class="mfid">{{ds['unique_id'][:13]}}</a>
                    <b>{{ds['dataset_name']}}</b> 
                    <!-- {{datasets_by_id[ds['unique_id']]['scientific_metadata']|string|truncate(1000)}} -->
                </li>
            {% endfor %}
            </ul>
        </li>
    </ul>
    </div>
{% endfor %}


<h2>Descendants</h2>
{% if not descendants_info %}
No Descendants
{% endif %}

{% for s in descendants_info %}
{% set name = s['sample_name'] %}
<div class="container p-4 border rounded-3 mt-2">

<h3>{{name}}
    <a href="/{{pc['project_id']}}/sample-graph/{{s['unique_id']}}" class="mfid">
        {{s['unique_id'][:13]}}</a>
</h3>
<ul>
    <li><b>Path:</b> {{" -> ".join(descendants_path[name])}}</li>
    <li><b>Description:</b> {{s['description']}}</li>
    <li><b>Datasets:</b>
        <ul>
        {% for ds in s['datasets'] %}
            <li>
                <a href="/{{pc['project_id']}}/dataset/{{ds['unique_id']}}" class="mfid">{{ds['unique_id'][:13]}}</a>
                <b>{{ds['dataset_name']}}</b> {{datasets_by_id[ds['unique_id']]['scientific_metadata']|string|truncate(1000)}}
            </li>
        {% endfor %}
        </ul>
    </li>
</ul>
</div>

{% endfor %}
{% endblock %}