{% extends "base.html" %}
{% block title %}Chat – {{pc['project_id']}}{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        #chat-wrapper {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 140px);
        }
        #chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }
        .msg-user {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 0.75rem;
        }
        .msg-user .bubble {
            background: #0d6efd;
            color: #fff;
            border-radius: 1rem 1rem 0.25rem 1rem;
            padding: 0.6rem 1rem;
            max-width: 75%;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .msg-assistant {
            display: flex;
            justify-content: flex-start;
            margin-bottom: 0.75rem;
        }
        .msg-assistant .bubble {
            background: #f1f3f5;
            color: #212529;
            border-radius: 1rem 1rem 1rem 0.25rem;
            padding: 0.6rem 1rem;
            max-width: 85%;
            word-break: break-word;
        }
        .msg-assistant .bubble p:last-child { margin-bottom: 0; }
        .tool-pill {
            font-size: 0.75em;
            font-family: monospace;
            background: #e9ecef;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 2px 8px;
            margin-bottom: 4px;
            cursor: pointer;
            display: inline-block;
        }
        .tool-pill-result {
            display: none;
            font-size: 0.72em;
            font-family: monospace;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 4px 8px;
            margin-bottom: 6px;
            max-height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .tool-group { margin-bottom: 4px; }
        #chat-input-area {
            border-top: 1px solid #dee2e6;
            padding-top: 0.75rem;
        }
        #chat-input {
            resize: none;
            overflow: hidden;
        }
        .typing-indicator span {
            display: inline-block;
            width: 7px; height: 7px;
            margin: 0 1px;
            background: #adb5bd;
            border-radius: 50%;
            animation: bounce 1.2s infinite;
        }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-6px); }
        }
    </style>
{% endblock %}

{% block breadcrumb %}
    <li class="breadcrumb-item"><a href="/{{pc['project_id']}}/"><b>Project</b> {{pc['project_id']}}</a></li>
    <li class="breadcrumb-item active" aria-current="page">Chat</li>
{% endblock %}

{% block content %}
<div id="chat-wrapper">
    <div class="d-flex align-items-center justify-content-between mb-2">
        <h1 class="mb-0">Chat <em>{{pc['project_id']}}</em></h1>
        <button class="btn btn-sm btn-outline-secondary" id="clear-btn">Clear</button>
    </div>

    <div id="chat-messages"></div>

    <div id="chat-input-area">
        <div class="d-flex gap-2">
            <textarea id="chat-input" class="form-control" rows="2"
                      placeholder="Ask about samples, datasets, or scientific metadata… (Enter to send, Shift+Enter for newline)"></textarea>
            <button id="send-btn" class="btn btn-primary px-3" style="align-self:flex-end;">Send</button>
        </div>
    </div>
</div>

<script>
const PROJECT_ID = {{ pc['project_id'] | tojson }};
const API_URL = `/${PROJECT_ID}/api/chat`;

let history = [];       // [{role: 'user'|'assistant', content: '...'}]
let streaming = false;

const messagesEl = document.getElementById('chat-messages');
const inputEl    = document.getElementById('chat-input');
const sendBtn    = document.getElementById('send-btn');
const clearBtn   = document.getElementById('clear-btn');

marked.setOptions({ breaks: true, gfm: true });

function escHtml(s) {
    return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function addUserBubble(text) {
    const div = document.createElement('div');
    div.className = 'msg-user';
    div.innerHTML = `<div class="bubble">${escHtml(text)}</div>`;
    messagesEl.appendChild(div);
    scrollToBottom();
}

function addTypingIndicator() {
    const div = document.createElement('div');
    div.className = 'msg-assistant';
    div.id = 'typing-indicator';
    div.innerHTML = `<div class="bubble typing-indicator"><span></span><span></span><span></span></div>`;
    messagesEl.appendChild(div);
    scrollToBottom();
    return div;
}

function removeTypingIndicator() {
    const el = document.getElementById('typing-indicator');
    if (el) el.remove();
}

function createAssistantBubble() {
    removeTypingIndicator();
    const outer = document.createElement('div');
    outer.className = 'msg-assistant';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    outer.appendChild(bubble);
    messagesEl.appendChild(outer);
    return bubble;
}

function addToolPill(bubble, name, inputObj) {
    const group = document.createElement('div');
    group.className = 'tool-group';

    const pill = document.createElement('div');
    pill.className = 'tool-pill';
    const inputPreview = JSON.stringify(inputObj).slice(0, 80);
    pill.textContent = `▶ ${name}(${inputPreview})`;

    const resultEl = document.createElement('div');
    resultEl.className = 'tool-pill-result';
    group.appendChild(pill);
    group.appendChild(resultEl);

    pill.addEventListener('click', () => {
        resultEl.style.display = resultEl.style.display === 'block' ? 'none' : 'block';
    });

    bubble.appendChild(group);
    scrollToBottom();
    return resultEl;
}

let _rawText = '';
let _currentBubble = null;
let _textEl = null;             // dedicated text div inside _currentBubble
let _pendingToolPills = [];     // ordered list of resultEls for tool_result events

function scrollToBottom() {
    messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendMessage() {
    if (streaming) return;
    const text = inputEl.value.trim();
    if (!text) return;

    inputEl.value = '';
    autoResizeTextarea();
    sendBtn.disabled = true;
    streaming = true;

    history.push({ role: 'user', content: text });
    addUserBubble(text);
    addTypingIndicator();

    _rawText = '';
    _currentBubble = null;
    _textEl = null;
    _pendingToolPills = [];

    try {
        const resp = await fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ history })
        });

        if (!resp.ok) {
            removeTypingIndicator();
            appendError(`HTTP ${resp.status}`);
            return;
        }

        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let buf = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            buf += decoder.decode(value, { stream: true });
            const lines = buf.split('\n\n');
            buf = lines.pop();   // keep incomplete chunk

            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                const event = JSON.parse(line.slice(6));
                handleEvent(event);
            }
        }
    } catch (e) {
        removeTypingIndicator();
        appendError(e.message);
    } finally {
        streaming = false;
        sendBtn.disabled = false;
        inputEl.focus();
    }
}

function handleEvent(event) {
    if (event.type === 'text') {
        removeTypingIndicator();
        if (!_currentBubble) {
            _currentBubble = createAssistantBubble();
        }
        if (!_textEl) {
            _textEl = document.createElement('div');
            _currentBubble.appendChild(_textEl);
        }
        _rawText += event.delta;
        _textEl.innerHTML = marked.parse(_rawText);
        scrollToBottom();

    } else if (event.type === 'image') {
        removeTypingIndicator();
        if (!_currentBubble) {
            _currentBubble = createAssistantBubble();
        }
        const img = document.createElement('img');
        img.src = event.src;
        img.alt = event.label || 'thumbnail';
        img.title = event.label || '';
        img.style.cssText = 'max-width:220px;max-height:180px;object-fit:contain;border:1px solid #dee2e6;border-radius:4px;display:block;margin:6px 0;cursor:pointer;';
        img.addEventListener('click', () => window.open(event.src, '_blank'));
        _currentBubble.appendChild(img);
        scrollToBottom();

    } else if (event.type === 'tool_call') {
        removeTypingIndicator();
        if (!_currentBubble) {
            _currentBubble = createAssistantBubble();
        }
        const resultEl = addToolPill(_currentBubble, event.name, event.input);
        _pendingToolPills.push(resultEl);

    } else if (event.type === 'tool_result') {
        const resultEl = _pendingToolPills.shift();
        if (resultEl) {
            resultEl.textContent = event.result;
        }

    } else if (event.type === 'error') {
        removeTypingIndicator();
        appendError(event.message);

    } else if (event.type === 'done') {
        if (_rawText) {
            history.push({ role: 'assistant', content: _rawText });
        }
        scrollToBottom();
    }
}

function appendError(msg) {
    const div = document.createElement('div');
    div.className = 'msg-assistant';
    div.innerHTML = `<div class="bubble text-danger">Error: ${escHtml(msg)}</div>`;
    messagesEl.appendChild(div);
    scrollToBottom();
}

function autoResizeTextarea() {
    inputEl.style.height = 'auto';
    inputEl.style.height = Math.min(inputEl.scrollHeight, 160) + 'px';
}

inputEl.addEventListener('input', autoResizeTextarea);

inputEl.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

sendBtn.addEventListener('click', sendMessage);

clearBtn.addEventListener('click', function() {
    history = [];
    messagesEl.innerHTML = '';
    _rawText = '';
    _currentBubble = null;
});
</script>
{% endblock %}
